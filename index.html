<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Rice Ideogram</title>

  <!-- for linear scale render -->
  <script src="http://mbostock.github.com/d3/d3.v2.js"></script>

  <!-- for chromosomes render -->
  <link type="text/css" rel="stylesheet" href="src/css/ideogram.css" />
  <script src="src/js/d3.min.js"></script>
  <script src="src/js/ideogram.js"></script>
  <script src="src/js/crossfilter.min.js"></script>
  <script src="src/js/ideogram.filter.js"></script>

  <!-- jQuery library -->
  <script src="src/js/jquery-3.2.1.js"></script>
  <!-- <script src="src/js/jquery-ui.min.js"></script> -->
  
  <!-- for form render -->
  <script src="src/js/jrf.form.js"></script>
  <!-- for spinner -->
  <script src="src/js/spin.min.js"></script>
  
  <!-- jqueries -->
  <!-- brush -->
  <script src="src/js/brush.js"></script>

  <!-- dropdown menu css -->
  <link type="text/css" rel="stylesheet" href="src/css/dropdownMenu.css">

  <script src="src/js/FileSaver.min.js"></script>
  <script src="src/js/tableexport.min.js"></script>
</head>

<body>
  <div id="main-container">
    <div id="sidebar">
      <div>
        <h1>Rice<br>Ideogram</h1>

      </div>
      <div>
        <ul id="view-type">
          <b>View type</b>
          <br/>
          <li>
            <label for="view-type_histogram">
              <input type="radio" name="view-type" id="view-type_histogram" onclick="getViewType(this.value)" value="Histogram" checked="checked">Histogram</input>
            </label>
            <label for="view-type_tracks" id="moveright">
              <input type="radio" name="view-type" id="view-type_tracks" onclick="getViewType(this.value)" value="Tracks">Tracks</input>
            </label>
          </li>
        </ul>
      </div>
      <br>
      <div id="form-render-category">
        <div class="expandable-panel" id="cp-1">
          <div class="expandable-panel-heading" id="collapsible-tg">
              <p><img src="https://maxcdn.icons8.com/Share/icon/Arrows//expand_arrow1600.png" alt="Smiley face" height="10" width="10" id="arrow-tg" class="arrow-left-stuff"><span id="span-tg"></span></p>
           </div>
          <div class="expandable-panel-content">
            <div style="height: 760px;" id="category-content-tg">
              
            </div>
          </div>
        </div>

        <div class="expandable-panel" id="cp-2">
          <div class="expandable-panel-heading" id="collapsible-qtl">
            <p><img src="https://maxcdn.icons8.com/Share/icon/Arrows//expand_arrow1600.png" alt="Smiley face" height="10" width="10" id="arrow-qtl" class="arrow-left-stuff"><span id="span-qtl"></span></p>
          </div>
          <div class="expandable-panel-content">
            <div style="height: 740px;" id="category-content-qtl">
              
            </div>
          </div>
        </div>
               
        <div class="expandable-panel" id="cp-3">
          <div class="expandable-panel-heading" id="collapsible-gq">
           <p><img src="https://maxcdn.icons8.com/Share/icon/Arrows//expand_arrow1600.png" alt="Smiley face" height="10" width="10" id="arrow-gq" class="arrow-left-stuff"><span id="span-gq"></span></p>
          </div>
          <div class="expandable-panel-content">
            <div style="height: 50px;" id="category-content-gq">
              <p style="margin-top: 20px;">No gene queries created yet.</p>
            </div>            
          </div>
        </div> 
      </div>
      <br>
      <div id="instructions">
        <div class="tab">
          <button class="tablinks-anotherone" onclick="anotherTab(event, 'Instructions')" id="goToInstr">Instructions</button>
          <button class="tablinks-anotherone" onclick="anotherTab(event, 'Settings')" id="">Settings</button>
        </div>
        <div id="Instructions" class="tabcontent-anotherone">
          <ul>
            <b>How to use</b>
            <li>* <u>Select trait gene(s).</u></li>
            <li>* <u>For histogram view</u>
              <br>- hover mouse on a bar to see count</li>
            <li>* <u>For tracks view</u>
              <br>- hover mouse on annotation to see
              <br>gene feature's name
              <br>- click annotation to view gene
              <br>feature in JBrowse</li>
          </ul>
        </div>
        <div id="Settings" class="tabcontent-anotherone">
          <b>Color scheme for ideogram:<br></b>
          <span id="nightmodebutton" class="button-color"><button type="button" onclick="turnNightMode()">Night mode</button></span>
          <br><br><b>Colorblind-friendly color scheme for track annotations:<br></b>
          <p>Protans are people with protanomaly, a type of red-green color blindness in which the red cones do not detect enough red. Click the button below to activate.</p>
          <span id="promode" class="button-color"><button type="button" onclick="colorBlindMode('proto')">Enable protan-friendly colors</button></span>
          <p>Deutans are people with deuteranomaly, a type of red-green color blindness in which the green cones do not detect enough green. Click the button below to activate.</p>
          <span id="deumode" class="button-color"><button type="button" onclick="colorBlindMode('deuto')">Enable deutan-friendly colors</button></span>
          <p>Tritans are people with tritanomaly, a type of blue-yellow color blindness in which the blue cones do not detect enough blue. Click the button below to activate.</p>
          <span id="trimode" class="button-color"><button type="button" onclick="colorBlindMode('trito')">Enable tritan-friendly colors</button></span>
        </div>
      </div>
    </div>

      <span class="button-color" id="download-ideogram"><button class="exportImageButton" onclick="exportSVG">Export to png</button></span>
    <div id="searchbox">
      <b>Search</b><span> gene position by keyword</span>
      <form class="form-wrapper cf">
        <input id="search-keyword" type="text" placeholder="Enter keyword here..." autofocus required>
        <button type="button" onclick="triggerSearchBox()" id="search-button">Search</button>
      </form>
      <p id="searchbox-keyword-message"><span id="searchbox-color"></span></p>
    </div>
    
    <div id="chromosome-render"></div>
    <br>
    <div class="gene-table" id="gt-div">
      <div class="tab">
        <button class="header-tab">Show results</button>
        <button class="tablinks" onclick="toggleResult(event, 'JBrowseView')" id="defaultOpen">JBrowse</button>
        <button class="tablinks" onclick="toggleResult(event, 'GeneTable')" id="goToTable">Gene table</button>
      </div>
      <div id="JBrowseView" class="tabcontent">
        <iframe id="jbrowse" src="http://172.29.4.215:8080/jbrowse-dev2/"></iframe>
      </div>
      <div id="GeneTable" class="tabcontent">
        <table id="gene-table-content" border="1" class="table"></table>
      </div>

    </div>
  </div>

  <script>
  // Get the element with id="defaultOpen" and click on it
  document.getElementById("defaultOpen").click();
  document.getElementById("goToInstr").click();

  var filterMap = {
    "traitGenes": {
      "oryzabase_trait_genes": 1,
      "qtaro_trait_genes": 2,
      "qtarogenes_bacterial_blight_resistance": 3,
      "qtarogenes_blast_resistance": 4,
      "qtarogenes_cold_tolerance": 5,
      "qtarogenes_culm_leaf": 6,
      "qtarogenes_drought_tolerance": 7,
      "qtarogenes_dwarf": 8,
      "qtarogenes_eating_quality": 9,
      "qtarogenes_flowering": 10,
      "qtarogenes_germination_dormancy": 11,
      "qtarogenes_insect_resistance": 12,
      "qtarogenes_lethality": 13,
      "qtarogenes_lodging_resistance": 14,
      "qtarogenes_morphological_trait": 15,
      "qtarogenes_other_disease_resistance": 16,
      "qtarogenes_other_soil_stress_tolerance": 17,
      "qtarogenes_other_stress_resistance": 18,
      "qtarogenes_others": 19,
      "qtarogenes_panicle_flower": 20,
      "qtarogenes_physiological_trait": 21,
      "qtarogenes_resistance_or_tolerance": 22,
      "qtarogenes_root": 23,
      "qtarogenes_salinity_tolerance": 24,
      "qtarogenes_seed": 25,
      "qtarogenes_sheath_blight_resistance": 26,
      "qtarogenes_shoot_seedling": 27,
      "qtarogenes_source_activity": 28,
      "qtarogenes_sterility": 29,
      "qtarogenes_submergency_tolerance": 30
    },
    "qtl": {
      "QTARO QTL": 1,
      "qtaroqtl_bacterial_blight_resistance": 2,
      "qtaroqtl_blast_resistance": 3,
      "qtaroqtl_cold_tolerance": 4,
      "qtaroqtl_culm_leaf": 5,
      "qtaroqtl_drought_tolerance": 6,
      "qtaroqtl_dwarf": 7,
      "qtaroqtl_eating_quality": 8,
      "qtaroqtl_flowering": 9,
      "qtaroqtl_germination_dormancy": 10,
      "qtaroqtl_insect_resistance": 11,
      "qtaroqtl_lethality": 12,
      "qtaroqtl_lodging_resistance": 13,
      "qtaroqtl_morphological_trait": 14,
      "qtaroqtl_other_disease_resistance": 15,
      "qtaroqtl_other_soil_stress_tolerance": 16,
      "qtaroqtl_other_stress_resistance": 17,
      "qtaroqtl_others": 18,
      "qtaroqtl_panicle_flower": 19,
      "qtaroqtl_physiological_trait": 20,
      "qtaroqtl_resistance_or_tolerance": 21,
      "qtaroqtl_root": 22,
      "qtaroqtl_salinity_tolerance": 23,
      "qtaroqtl_seed": 24,
      "qtaroqtl_sheath_blight_resistance": 25,
      "qtaroqtl_shoot_seedling": 26,
      "qtaroqtl_source_activity": 27,
      "qtaroqtl_sterility": 28,
      "qtaroqtl_submergency_tolerance": 29
    }
  };

  /* annotColorConfig */
  var colorSettings = defaultColor;
  // var colorSettings = nightModeColor;

  /* width and height config */
  var w = $(window).width() * .01,
    h = $(window).height() * .9;

  // $+- brush function:: data presentation
  function writeSelectedRange(){}

  // &+- to determine whether the color blocks must appear or not
  var isTracksOn = false;

  var config = {
    organism: "rice",
    barWidth: 4,
    chrWidth: 18,
    chrHeight: 800,
    chrMargin: 30,
    annotationHeight: 4,
    annotationTracks: colorSettings,
    annotationsLayout: "tracks",
    container: "#chromosome-render",

    // &+- added the brush feature
    brush: true,
    onBrushMove: writeSelectedRange,
    onLoad: writeSelectedRange
  };

  var ideogram;

  /* 
   * toggles view using radio buttons
   */
  function getViewType(viewType) {

    var text = "";

    // change view to viewType
    if (viewType === "Histogram") {
      config.annotationsLayout = "histogram";
      text = "<b>Histogram view</b><br>Hover your mouse on a histogram bar to see count";
      
      // &+- reinitialize colorSettings (color blocks)
      // for (i = 0; i < colorSettings.length; i++) {
      //   colorFillBlock = "transparent";
      //   traitGeneID = '#color-block-' + (i);
      //   qtlID = '#color-block-' + (i + 30);
      //   $(traitGeneID).css({"outline-color": colorFillBlock, "background-color": colorFillBlock});
      //   $(qtlID).css({"outline-color": colorFillBlock, "background-color": colorFillBlock});
      // }
      // isTracksOn = false;
    
    } else if (viewType === "Tracks") {
      config.annotationsLayout = "tracks";
      text = "<b>Tracks view</b><br>Hover your mouse on an annotation to see gene feature's name";
    
      // &+- determine whether the user has clicked a trait/qtl while the user was on histogram mode going to track mode
      // jQuery.each(filterMap["qtl"], function(key, value){
      //   if(key === "QTARO QTL") key = "qtaroqtl"; 

      //   // &+- toggles on qtl 
      //   var IDForm = "filter-qtl-" + key;
      //   if($('input#' + IDForm).is(':checked')){
      //     fillColorBlock();
      //   }
      //   isTracksOn = true;

      //   // &+- changes radio to checkbox
      //   $('#filter-qtl-' + key).attr('name', key);
      //   $('#filter-qtl-' + key).attr('type', 'checkbox');
      // });
      // jQuery.each(filterMap["traitGenes"], function(key, value){
      //   // &+- toggles on trait genes
      //   var IDForm = "filter-traitGenes-" + key;
      //   if($('input#' + IDForm).is(':checked')){
      //     fillColorBlock();
      //   }
      //   isTracksOn = true;

      //   // &+- changes radio to checkbox
      //   $('#filter-traitGenes-' + key).attr('name', key);
      //   $('#filter-traitGenes-' + key).attr('type', 'checkbox');
      // });
    }

    // show linear scale
    toggleLinearScale("show");

    // clear current view
    d3.select("svg").remove();

    ideogram = new Ideogram(config);
    adjustIdeogramSVG();
    dropdownMenuSetup();
  };

  /*
   * triggered when checkbox is clicked to filter both histogram
   * and tracks view, as well the data in allTraitData
   */
  function toggleFilter(checkbox) {
    var id = checkbox.id,
      color, counts, key, count;
    /* get value of tracks attribute */
    var selectedTrack = $("#" + id).attr("tracks");

    if(selectedTrack.indexOf('brush') !== -1){
      // console.log(checkbox.id);
      var number = parseInt(checkbox.id.replace(/[^0-9\.]/g, ''), 10);
      color = arrayOfColorsBrushes[(number-59)];
      // color = shadeColor("#000000", 100 - (brushSelectionAnnot * 10));
      // console.log(color);
    }
    else{
      if(isTracksOn){
        // &+- added qtl data, more filering, more fun!
        if(checkbox.id.match('traitGenes') != null){
          color = colorSettings[filterMap["traitGenes"][selectedTrack] - 1]["color"];
        }
        else if(checkbox.id.match('qtl') != null){
          color = colorSettings[filterMap["qtl"][selectedTrack]]["color"];      
        }
      }
    }
    
    if ($("#" + id).is(':checked')) {
      addTrack(selectedTrack);
      if(selectedTrack.indexOf('brush') === -1){
        /* get trackData urls */
        var trackDataUrls = getTrackDataUrls(selectedTrack);

        /* empty traitData to avoid duplication */
        traitData = [];

        /* clear current view */
        d3.select("#ideogram").remove();

        /* create new view w/ selectedTrack annots */
        ideogram = getTrackData(selectedTrack, trackDataUrls, config);
      }
      else{
        for(var i = 0; i < brushAnnots.length; i++) {
          ideogram.drawProcessedAnnots(brushAnnots[i]);
          addAnnotationLinks();
        }
      }

      /* show annots/tracks (tracks view filtering) */
      d3.selectAll("path[fill = '" + color + "']").attr("visibility", "show");
    }
    else {
      removeTrack(selectedTrack);

      /* update allTraitData */
      var ra = removeSelectedTrack(selectedTrack);
      config.rawAnnots = ra;

      /* clear current view */
      d3.select("#ideogram").remove();

      /* new view without selectedTrack*/
      ideogram = new Ideogram(config);

      /* hide annots/tracks (tracks view filtering) */
      d3.selectAll("path[fill = '" + color + "']").attr("visibility", "hidden");

      if(brushAnnots.length > 0){
        for(var i = 0; i < brushAnnots.length; i++) {
          var selection = brushAnnots[i][annots];
          for(var j = 0; j < brushAnnots.length; j++) {
            selection[j]['trackIndex'] = selection[j]['trackIndex'] - 1;
          }
          
          // ideogram.drawProcessedAnnots(brushAnnots[i]);
          // addAnnotationLinks();
        }
      }
    }
    if (getAllTracksCount() > 0) {
      $("#jb-div").show();
    }

  }

  // &+- fills up the color blocks. the color in the color blocks will correspond to the
  // &+- color used in the tracks annotations (only) || triggered when a user picks one from the 
  // &+- checkbox of trait genes/qtl

  function colorBlindMode(category){
      if(category === 'proto') config.annotationTracks = protanopiaNoRed;
      else if(category === 'deuto') config.annotationTracks = deutanopiaNoGreen;
      else config.annotationTracks = tritanopiaNoBlue;

      // show linear scale
      toggleLinearScale("show");

      // clear current view
      d3.select("svg").remove();

      ideogram = new Ideogram(config);
      adjustIdeogramSVG();
      dropdownMenuSetup();
      fillColorBlock();
  }

  /* render default view as histogram */
  // getViewType("Histogram");
  getViewType("Tracks");

  renderCollapsible("/ideogram-extension/data/filter/dataSet.json");
  plugCollapsibleJQuery();
  fillColorBlock();

  document.getElementById("collapsible-gq").click();
  $('body').css({'background-color': '#E0E0E0', 'color': 'black'});
  
  /* default of jbrowse is hidden */
  $("#jbrowse").hide();
  </script>
</body>
</html>