<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Rice Ideogram</title>

  <!-- for linear scale render -->
  <script src="http://mbostock.github.com/d3/d3.v2.js"></script>

  <!-- for chromosomes render -->
  <link type="text/css" rel="stylesheet" href="src/css/ideogram.css" />
  <script type="text/javascript" src="src/js/d3.min.js"></script>
  <script type="text/javascript" src="src/js/ideogram.js"></script>
  <script type="text/javascript" src="src/js/crossfilter.min.js"></script>
  <script type="text/javascript" src="src/js/ideogram.filter.js"></script>

  <!-- jQuery library -->
  <script type="text/javascript" src="src/js/jquery-3.2.1.js"></script>
  <!-- <script type="text/javascript" src="src/js/jquery-ui.min.js"></script> -->
  
  <!-- for form render -->
  <script ty1pe="text/javascript" src="src/js/jrf.form.js"></script>
  <!-- for spinner -->
  <script type="text/javascript" src="src/js/spin.min.js"></script>
  
  <!-- jqueries -->
  <!-- brush -->
  <script type="text/javascript" src="src/js/brush.js"></script>

  <!-- dropdown menu css -->
  <link type="text/css" rel="stylesheet" href="src/css/dropdownMenu.css">
</head>

<body>
  <div id="main-container">
    <div id="sidebar">
      <div>
        <h1>Rice<br>Ideogram</h1>

      </div>
      <div>
        <ul id="view-type">
          <b>View type</b>
          <br/>
          <li>
            <label for="view-type_histogram">
              <input type="radio" name="view-type" id="view-type_histogram" onclick="getViewType(this.value)" value="Histogram" checked="checked">Histogram</input>
            </label>
          </li>
          <li>
            <label for="view-type_tracks">
              <input type="radio" name="view-type" id="view-type_tracks" onclick="getViewType(this.value)" value="Tracks">Tracks</input>
            </label>
          </li>
        </ul>
      </div>

      <br>
      <div id="form-render"></div>
      <br>
      <div id="form-render-qtl"></div>
      <br>
      <div id="form-render-brush"></div>  
      <br>
      <div id="instructions">
        <ul>
          <b>How to use</b>
          <li>* <u>Select trait gene(s).</u></li>
          <li>* <u>For histogram view</u>
            <br>- hover mouse on a bar to see count</li>
          <li>* <u>For tracks view</u>
            <br>- hover mouse on annotation to see
            <br>gene feature's name
            <br>- click annotation to view gene
            <br>feature in JBrowse</li>
        </ul>

      </div>
    </div>

    <div id="searchbox">
      <b>Search</b><span> gene position by keyword</span>
      <form class="form-wrapper cf">
        <input id="search-keyword" type="text" placeholder="Enter keyword here..." autofocus required>
        <button type="button" onclick="triggerSearchBox()">Search</button>
      </form>
      <p id="searchbox-keyword-message"><span id="searchbox-color"></span></p>
    </div>
        <span class="nightmodebutton">
        <button type="button" onclick="turnNightMode()">Night mode</button>
        </span>
    <div id="chromosome-render"></div>
    <br>

    <div id="jb-div">
    </div>

    <div class="gene-table" id="gt-div">

      <div class="tab">
        <button class="header-tab">Show results</button>
        <button class="tablinks" onclick="toggleResult(event, 'JBrowseView')" id="defaultOpen">JBrowse</button>
        <button class="tablinks" onclick="toggleResult(event, 'GeneTable')" id="goToTable">Gene table</button>
      </div>
      <div id="JBrowseView" class="tabcontent">
        <iframe id="jbrowse" src="http://172.29.4.215:8080/jbrowse-dev2/"></iframe>
      </div>

      <div id="GeneTable" class="tabcontent">
        <table id="gene-table-content" border="1" class="table"></table>
      </div>
    </div>
  </div>

  <script>
  // Get the element with id="defaultOpen" and click on it
  document.getElementById("defaultOpen").click();

  var filterMap = {
    "traitGenes": {
      "oryzabase_trait_genes": 1,
      "qtaro_trait_genes": 2,
      "qtarogenes_bacterial_blight_resistance": 3,
      "qtarogenes_blast_resistance": 4,
      "qtarogenes_cold_tolerance": 5,
      "qtarogenes_culm_leaf": 6,
      "qtarogenes_drought_tolerance": 7,
      "qtarogenes_dwarf": 8,
      "qtarogenes_eating_quality": 9,
      "qtarogenes_flowering": 10,
      "qtarogenes_germination_dormancy": 11,
      "qtarogenes_insect_resistance": 12,
      "qtarogenes_lethality": 13,
      "qtarogenes_lodging_resistance": 14,
      "qtarogenes_morphological_trait": 15,
      "qtarogenes_other_disease_resistance": 16,
      "qtarogenes_other_soil_stress_tolerance": 17,
      "qtarogenes_other_stress_resistance": 18,
      "qtarogenes_others": 19,
      "qtarogenes_panicle_flower": 20,
      "qtarogenes_physiological_trait": 21,
      "qtarogenes_resistance_or_tolerance": 22,
      "qtarogenes_root": 23,
      "qtarogenes_salinity_tolerance": 24,
      "qtarogenes_seed": 25,
      "qtarogenes_sheath_blight_resistance": 26,
      "qtarogenes_shoot_seedling": 27,
      "qtarogenes_source_activity": 28,
      "qtarogenes_sterility": 29,
      "qtarogenes_submergency_tolerance": 30
    },
    "qtl": {
      "QTARO QTL": 1,
      "qtaroqtl_bacterial_blight_resistance": 2,
      "qtaroqtl_blast_resistance": 3,
      "qtaroqtl_cold_tolerance": 4,
      "qtaroqtl_culm_leaf": 5,
      "qtaroqtl_drought_tolerance": 6,
      "qtaroqtl_dwarf": 7,
      "qtaroqtl_eating_quality": 8,
      "qtaroqtl_flowering": 9,
      "qtaroqtl_germination_dormancy": 10,
      "qtaroqtl_insect_resistance": 11,
      "qtaroqtl_lethality": 12,
      "qtaroqtl_lodging_resistance": 13,
      "qtaroqtl_morphological_trait": 14,
      "qtaroqtl_other_disease_resistance": 15,
      "qtaroqtl_other_soil_stress_tolerance": 16,
      "qtaroqtl_other_stress_resistance": 17,
      "qtaroqtl_others": 18,
      "qtaroqtl_panicle_flower": 19,
      "qtaroqtl_physiological_trait": 20,
      "qtaroqtl_resistance_or_tolerance": 21,
      "qtaroqtl_root": 22,
      "qtaroqtl_salinity_tolerance": 23,
      "qtaroqtl_seed": 24,
      "qtaroqtl_sheath_blight_resistance": 25,
      "qtaroqtl_shoot_seedling": 26,
      "qtaroqtl_source_activity": 27,
      "qtaroqtl_sterility": 28,
      "qtaroqtl_submergency_tolerance": 29
    }
  };

  /* annotColorConfig */
  var colors = [{
      "id": "oryzabase_trait_genes",   
      "displayName": "Oryzabase Trait Gene Loci",
      "color": "#ff0000"
    }, {
      "id": "qtaro_trait_genes",
      "id2": "qtaroqtlt",      
      "displayName": "All QTARO trait genes",
      "color": "#ff4000"
    }, {
      "id": "qtarogenes_bacterial_blight_resistance",
      "id2": "qtaroqtl_bacterial_blight_resistance",      
      "displayName": "Bacterial blight resistance",
      "color": "#ff8000"
    }, {
      "id": "qtarogenes_blast_resistance",
      "id2": "qtaroqtl_blast_resistance",      
      "displayName": "Blast resistance",
      "color": "#ffbf00"
    }, {
      "id": "qtarogenes_cold_tolerance",
      "id2": "qtaroqtl_cold_tolerance",      
      "displayName": "Cold tolerance",
      "color": "#bfff00"
    }, {
      "id": "qtarogenes_culm_leaf",
      "id2": "qtaroqtl_culm_leaf",      
      "displayName": "Culm leaf",
      "color": "#80ff00"
    }, {
      "id": "qtarogenes_drought_tolerance",
      "id2": "qtaroqtl_drought_tolerance",      
      "displayName": "Drought tolerance",
      "color": "#40ff00"
    }, {
      "id": "qtarogenes_dwarf",
      "id2": "qtaroqtl_dwarf",      
      "displayName": "Dwarf",
      "color": "#00ff00"
    }, {
      "id": "qtarogenes_eating_quality",
      "id2": "qtaroqtl_eating_quality",      
      "displayName": "Eating quality",
      "color": "#00ff40"
    }, {
      "id": "qtarogenes_flowering",
      "id2": "qtaroqtl_flowering",      
      "displayName": "Flowering Trait",
      "color": "#00ff80"
    }, {
      "id": "qtarogenes_germination_dormancy",
      "id2": "qtaroqtl_germination_dormancy",      
      "displayName": "Germination dormancy",
      "color": "#00ffbf"
    }, {
      "id": "qtarogenes_insect_resistance",
      "id2": "qtaroqtl_insect_resistance",      
      "displayName": "Insect resistance",
      "color": "#00ffff"
    }, {
      "id": "qtarogenes_lethality",
      "id2": "qtaroqtl_lethality",      
      "displayName": "Lethality Trait",
      "color": "#00bfff"
    }, {
      "id": "qtarogenes_lodging_resistance",
      "id2": "qtaroqtl_lodging_resistance",      
      "displayName": "Lodging resistance",
      "color": "#0080ff"
    }, {
      "id": "qtarogenes_morphological_trait",
      "id2": "qtaroqtl_morphological_trait",      
      "displayName": "Morphological trait",
      "color": "#0040ff"
    }, {
      "id": "qtarogenes_other_disease_resistance",
      "id2": "qtaroqtl_other_disease_resistance",      
      "displayName": "Other disease resistance",
      "color": "#0000ff"
    }, {
      "id": "qtarogenes_other_soil_stress_tolerance",
      "id2": "qtaroqtl_other_soil_stress_tolerance",      
      "displayName": "Other soil stress tolerance",
      "color": "#4000ff"
    }, {
      "id": "qtarogenes_other_stress_resistance",
      "id2": "qtaroqtl_other_stress_resistance",      
      "displayName": "Other stress resistance",
      "color": "#8000ff"
    }, {
      "id": "qtarogenes_others",
      "id2": "qtaroqtl_others",      
      "displayName": "Others",
      "color": "#bf00ff"
    }, {
      "id": "qtarogenes_panicle_flower",
      "id2": "qtaroqtl_panicle_flower",      
      "displayName": "Panicle flower",
      "color": "#ff00ff"
    }, {
      "id": "qtarogenes_physiological_trait",
      "id2": "qtaroqtl_physiological_trait",      
      "displayName": "Physiological trait",
      "color": "#ff00bf"
    }, {
      "id": "qtarogenes_resistance_or_tolerance",
      "id2": "qtaroqtl_resistance_or_tolerance",      
      "displayName": "Resistance or tolerance",
      "color": "#ff0080"
    }, {
      "id": "qtarogenes_root",
      "id2": "qtaroqtl_root",      
      "displayName": "Root",
      "color": "#ff0040"
    }, {
      "id": "qtarogenes_salinity_tolerance",
      "id2": "qtaroqtl_salinity_tolerance",      
      "displayName": "Salinity tolerance",
      "color": "#b94646"
    }, {
      "id": "qtarogenes_seed",
      "id2": "qtaroqtl_seed",      
      "displayName": "Seed",
      "color": "#99ccff"
    }, {
      "id": "qtarogenes_sheath_blight_resistance",
      "id2": "qtaroqtl_sheath_blight_resistance",      
      "displayName": "Sheath blight resistance",
      "color": "#D0906D"
    }, {
      "id": "qtarogenes_shoot_seedling",
      "id2": "qtaroqtl_shoot_seedling",      
      "displayName": "Shoot seedling",
      "color": "#004080"
    }, {
      "id": "qtarogenes_source_activity",
      "id2": "qtaroqtl_source_activity",      
      "displayName": "Source activity",
      "color": "#ddb880"
    }, {
      "id": "qtarogenes_sterility",
      "id2": "qtaroqtl_sterility",      
      "displayName": "Sterility",
      "color": "#a6ccf2"
    }, {
      "id": "qtarogenes_submergency_tolerance",
      "id2": "qtaroqtl_submergency_tolerance",      
      "displayName": "Submergency tolerance",
      "color": "#ff9999"
  }];


  /* width and height config */
  var w = $(window).width() * .01,
    h = $(window).height() * .9;

  // $+- brush function:: data presentation
  function writeSelectedRange() {
    // for(var i = 0; i < selectedRegion.length; i++){
    //   var r = selectedRegion[i],
    //       to = r.from.toLocaleString(), // Adds thousands-separator
    //       from = r.to.toLocaleString(),
    //       extent = r.extent.toLocaleString();

    //   document.getElementById("from" + (i+1)).innerHTML = to;
    //   document.getElementById("to" + (i+1)).innerHTML = from;
    //   document.getElementById("extent" + (i+1)).innerHTML = extent;
    // }
  }

  // &+- to determine whether the color blocks must appear or not
  var isTracksOn = false;

  var config = {
    organism: "rice",
    barWidth: 4,
    chrWidth: 18,
    chrHeight: 800,
    chrMargin: 30,
    annotationHeight: 4,
    annotationTracks: colors,
    annotationsLayout: "tracks",
    container: "#chromosome-render",

    // &+- added the brush feature
    brush: true,
    onBrushMove: writeSelectedRange,
    onLoad: writeSelectedRange
  };

  var ideogram;

  /* 
   * toggles view using radio buttons
   */
  function getViewType(viewType) {

    var text = "";

    // change view to viewType
    if (viewType === "Histogram") {
      config.annotationsLayout = "histogram";
      text = "<b>Histogram view</b><br>Hover your mouse on a histogram bar to see count";
      
      // &+- reinitialize colors (color blocks)
      for (i = 0; i < colors.length; i++) {
        colorFillBlock = "white";
        traitGeneID = '#color-block-' + (i);
        qtlID = '#color-block-' + (i + 30);
        $(traitGeneID).css({"outline-color": colorFillBlock, "background-color": colorFillBlock});
        $(qtlID).css({"outline-color": colorFillBlock, "background-color": colorFillBlock});
      }
      isTracksOn = false;
    
    } else if (viewType === "Tracks") {
      config.annotationsLayout = "tracks";
      text = "<b>Tracks view</b><br>Hover your mouse on an annotation to see gene feature's name";
    
      // &+- determine whether the user has clicked a trait/qtl while the user was on histogram mode going to track mode
      jQuery.each(filterMap["qtl"], function(key, value){
        if(key === "QTARO QTL") key = "qtaroqtl"; 

        // &+- toggles on qtl 
        var IDForm = "filter-qtl-" + key;
        if($('input#' + IDForm).is(':checked')){
          fillColorBlock("qtl");
        }
        isTracksOn = true;

        // &+- changes radio to checkbox
        $('#filter-qtl-' + key).attr('name', key);
        $('#filter-qtl-' + key).attr('type', 'checkbox');
      });
      jQuery.each(filterMap["traitGenes"], function(key, value){
        // &+- toggles on trait genes
        var IDForm = "filter-traitGenes-" + key;
        if($('input#' + IDForm).is(':checked')){
          fillColorBlock("traitGenes");
        }
        isTracksOn = true;

        // &+- changes radio to checkbox
        $('#filter-traitGenes-' + key).attr('name', key);
        $('#filter-traitGenes-' + key).attr('type', 'checkbox');
      });
    }

    // show linear scale
    toggleLinearScale("show");

    // clear current view
    d3.select("svg").remove();

    ideogram = new Ideogram(config);
    // &+- added brush settings
    // &+- providing a larger svg for the dropdown menu 
            $('#ideogram').attr('width', '1200');
            $('#ideogram').attr('height', '1200');

            // &+- change cursor
            $('.background').css('cursor', 'zoom-in');

            // &+- makes the dropdown be located somewhere outside the user's view
            $('.dynamic-dropdown').attr('transform', 'translate(-300, -300)');

            // &+- add dropdown menu after using the brush
            $('.dynamic-dropdown').wrapInner(dropdownMenuForm);
            
            // &+- makes the dropdown menu appear when the mouse is hovered on the selection of the brush
            $(".extent").hover(
                function( event ) {
                    brushID = $(this).parent().attr('id');
                    
                    // &+- used in getting the details for start and end
                    if(previousBrush === 'some-id-i-used-to-know') $('#' + previousBrush).attr('id', ('some-id-' + brushID));
                    else $('#some-id-' + previousBrush).attr('id', ('some-id-' + brushID));
                    previousBrush = brushID;

                    // &+- makes the show in JBrowse unable to click
                    var countingTrue = 0;
                    for (var i = 0; i < ideogram.numChromosomes; i++) {
                        if(isBrushActive[i]) countingTrue++;
                    }
                    if(countingTrue > 1){
                        // &+- make it inactive
                        $('.show-jbrowse').attr('class', 'inactive-link show-jbrowse'); 
                    }
                    else{
                        // &+- make it active again
                        $('.show-jbrowse').attr('class', 'active-link show-jbrowse');                 
                    }

                    // &+- displays the current chromosome name in the bottom of the menu
                    var number = parseInt(brushID.replace(/[^0-9\.]/g, ''), 10),
                        limit = ideogram.chromosomesArray[number].bands[1].bp.stop;
                    $('#chr-name').text('chr ' + (number + 1) + ' | ');
                    $('#chr-name-max').text(' ' + limit);

                    // &+- displays the current base pairs on focus
                    $('#startBPTextbox').val(selectedRegion[number].from);
                    $('#endBPTextbox').val(selectedRegion[number].to);

                    // &+- make the menu visible
                    $('.file_menu').css('display', 'visible');

                    // &+- for the foreignObjectobject tag inside the svg tag
                    $('.dynamic-dropdown').attr('transform', 'translate(' + (event.pageX-270) + ', ' + (event.pageY-50) + ')'); 
                    $('ul.file_menu').stop(true, true).slideDown('medium');

                    // &+- add the brush id to the anchor tag (used in brush deletion and submission of coordinates)
                    $('.identify-the-brush').attr('id', brushID); 
                    $('.submit-chr-details').attr('id', brushID);
                    $('.show-jbrowse').attr('id', brushID);  

                    // &+- makes the brush visible when the mouse is on the menu
                    $('#' + $(this).parent().attr('id')).css('visibility', 'visible');

                    isMenuOpen[number] = true;
                },
                function() {
                }
            );

            // &+- makes the brush re-appear again when the mouse is on the menu
            $('.dynamic-dropdown').hover(function(){ 
            }, function(){ 
                // &+- make the menu return to nowhere
                $('ul.file_menu').stop(true, true).slideUp('medium');        

                // &+- clear form contents
                $('#startBPTextbox').val('');
                $('#endBPTextbox').val('');
                $('#message-input-menu').text('');        

                // &+- reset colors
                $('#startBPTextbox').css('background-color', 'white');
                $('#startBPTextbox').css('color', 'black');

                $('#endBPTextbox').css('background-color', 'white');
                $('#endBPTextbox').css('color', 'black');
            });
  };

  /*
   * triggered when checkbox is clicked to filter both histogram
   * and tracks view, as well the data in allTraitData
   */
  function toggleFilter(checkbox) {
    var id = checkbox.id,
      color, counts, key, count;

    /* get value of tracks attribute */
    var selectedTrack = $("#" + id).attr("tracks");

    if(selectedTrack.indexOf('brush') !== -1){
      console.log(checkbox.id);
      var number = parseInt(checkbox.id.replace(/[^0-9\.]/g, ''), 10);
      color = arrayOfColorsBrushes[number];
      // color = shadeColor("#000000", 100 - (brushSelectionAnnot * 10));
      // console.log(color)
      for (i = 0; i < (brushSelectionAnnot+1); i++) {
        $('#color-block' + (i+100)).css({"outline-color": color, "background-color": color});
      }
    }
    else{
      // &+- reinitialize colors (color blocks)
      for (i = 0; i < colors.length; i++) {
        colorFillBlock = "white";
        traitGeneID = '#color-block-' + (i);
        qtlID = '#color-block-' + (i + 30);
        $(traitGeneID).css({"outline-color": colorFillBlock, "background-color": colorFillBlock});
        $(qtlID).css({"outline-color": colorFillBlock, "background-color": colorFillBlock});
      }
      // &+- color blocks will only trigger when the user picks tracks view
      if(isTracksOn){
        // &+- added qtl data, more filering, more fun!
        if(checkbox.id.match('traitGenes') != null){
          fillColorBlock("traitGenes");
          color = colors[filterMap["traitGenes"][selectedTrack] - 1]["color"];
        }
        else if(checkbox.id.match('qtl') != null){
          fillColorBlock("qtl");  
          color = colors[filterMap["qtl"][selectedTrack]]["color"];      
        }
      }
    }

    if ($("#" + id).is(':checked')) {
      addTrack(selectedTrack);
      if(selectedTrack.indexOf('brush') === -1){
        /* get trackData urls */
        var trackDataUrls = getTrackDataUrls(selectedTrack);

        /* empty traitData to avoid duplication */
        traitData = [];

        /* clear current view */
        d3.select("#ideogram").remove();

        /* create new view w/ selectedTrack annots */
        ideogram = getTrackData(selectedTrack, trackDataUrls, config);

      }


      /* show annots/tracks (tracks view filtering) */
      d3.selectAll("path[fill = '" + color + "']").attr("visibility", "show");


    }
    else {
      removeTrack(selectedTrack);
      if(selectedTrack.indexOf('brush') === -1){

        /* update allTraitData */
        var ra = removeSelectedTrack(selectedTrack);
        config.rawAnnots = ra;

        /* clear current view */
        d3.select("#ideogram").remove();

        /* new view without selectedTrack*/
        ideogram = new Ideogram(config);
        
      }

      /* hide annots/tracks (tracks view filtering) */
      d3.selectAll("path[fill = '" + color + "']").attr("visibility", "hidden");
    }
    if (getAllTracksCount() > 0) {
      $("#jb-div").show();
    }
  }

  // &+- fills up the color blocks. the colors in the colors blocks will correspond to the
  // &+- colors used in the tracks annotations (only) || triggered when a user picks one from the 
  // &+- checkbox of trait genes/qtl
  function fillColorBlock(category){
    var colors = [
        "#ff0000",
        "#ff4000",
        "#ff8000",
        "#ffbf00",
        "#bfff00",
        "#80ff00",
        "#40ff00",
        "#00ff00",
        "#00ff40",
        "#00ff80",
        "#00ffbf",
        "#00ffff",
        "#00bfff",
        "#0080ff",
        "#0040ff",
        "#0000ff",
        "#4000ff",
        "#8000ff",
        "#bf00ff",
        "#ff00ff",
        "#ff00bf",
        "#ff0080",
        "#ff0040",
        "#b94646",
        "#99ccff",
        "#D0906D",
        "#004080",
        "#ddb880",
        "#a6ccf2",
        "#ff9999"
    ];

    $(document).ready(function(){
        var colorFillBlock, traitGeneID, qtlID, i;

        // &+- adding color blocks to the trait genes section
        for (i = 0; i < colors.length; i++) {
            colorFillBlock = colors[i];
            traitGeneID = '#color-block-' + (i);
            qtlID = '#color-block-' + (i + 30);
            if(category === "traitGenes"){
              $(traitGeneID).css({"outline-color": colorFillBlock, "background-color": colorFillBlock});
            }
            else if(category === "qtl"){
              $(qtlID).css({"outline-color": colorFillBlock, "background-color": colorFillBlock});
            }
        }
    });
  }

  /* render default view as histogram */
  getViewType("Histogram");
  // getViewType("Tracks");

  var category;
  if($("#view-type_histogram").is(':checked')) {
    category = "histogram";
  }
  else{
    category = "tracks";
  }

  /* render form */
  var filepath = "/ideogram-extension/data/filter/traitGenes.json";
  renderForm(filepath, category);

  // &+- addition of the quantitativeTraitLoci.json
  var filepath = "/ideogram-extension/data/filter/quantitativeTraitLoci.json";
  renderForm(filepath, category);

  /* default of jbrowse is hidden */
  $("#jbrowse").hide();
  </script>
</body>
</html>